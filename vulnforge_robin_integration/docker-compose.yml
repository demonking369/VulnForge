version: "3.9"

services:
  api:
    build: .
    env_file: .env
    command: uvicorn vulnforge_robin_integration.api.app:app --host 0.0.0.0 --port 8080
    ports:
      - "8080:8080"
    volumes:
      - ./samples/inbox:/data/robin/outbox:ro
      - ./data:/app/data
    depends_on:
      - broker
      - db
    networks:
      - integration

  worker:
    build: .
    env_file: .env
    command: celery -A vulnforge_robin_integration.workers.app worker --loglevel=info
    volumes:
      - ./data:/app/data
    depends_on:
      - broker
      - db
    networks:
      - integration

  broker:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - integration

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: vulnforge
      POSTGRES_USER: vulnforge
      POSTGRES_PASSWORD: vulnforge
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - integration

  robin:
    image: alpine:3
    command: ["/bin/sh","-c","mkdir -p /data/robin/outbox && tail -f /dev/null"]
    volumes:
      - ./samples/inbox:/data/robin/outbox
    networks:
      - robin_isolated

networks:
  integration:
  robin_isolated:
    driver: bridge

volumes:
  db_data:

